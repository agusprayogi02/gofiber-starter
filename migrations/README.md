# Migrations Directory

This directory contains database migration files generated by **Atlas** from GORM entities.

> **üìñ Full Documentation**: 
> - **Quick Start**: [docs/MIGRATION_GUIDE.md](../docs/MIGRATION_GUIDE.md) (Bahasa Indonesia)
> - **Complete Guide**: [docs/DATABASE.md](../docs/DATABASE.md)
> - **Commands**: [docs/MAKEFILE_COMMANDS.md](../docs/MAKEFILE_COMMANDS.md)

## What is Atlas?

Atlas automatically generates SQL migrations from your GORM models. **No manual SQL writing needed!**

## Quick Commands

```bash
# 1. Install Atlas
make atlas-install

# 2. Generate migration (after modifying GORM entities)
make atlas-diff
# or with custom name
make atlas-diff-name NAME=add_user_bio

# 3. Review generated SQL
cat migrations/[timestamp]_[name].sql

# 4. Apply migration
make atlas-apply

# 5. Check status
make atlas-status
```

> **üí° Note**: Database URL is auto-generated from your existing ENV variables via `scripts/get-atlas-url.sh`  
> Uses: DB_USER, DB_PASS, DB_URL, DB_NAME, DB_TYPE. No need to set ATLAS_DB_URL separately!

## Adding New Model

**Step 1**: Create GORM entity in `internal/domain/<name>/entity.go`

**Step 2**: Register in `internal/config/database.go`:
```go
func GetModelsForMigration() []interface{} {
    return []interface{}{
        &user.User{},
        &yourmodel.YourModel{}, // Add here
    }
}
```

**Step 3**: Generate & apply migration:
```bash
make atlas-diff-name NAME=create_yourmodel_table
make atlas-apply
```

## Migration Files

Migration files are named: `[timestamp]_[description].sql`

Example:
```
migrations/
‚îú‚îÄ‚îÄ 20260107120000_create_users.sql
‚îú‚îÄ‚îÄ 20260107120001_add_user_bio.sql
‚îî‚îÄ‚îÄ atlas.sum (checksum file)
```

**‚ö†Ô∏è NEVER edit migration files manually after applying!**

## Environments

```bash
# Development
make atlas-apply          # uses ATLAS_DEV_DB_URL

# Production
make atlas-apply-prod     # uses ATLAS_DB_URL (with confirmation)
```

## Troubleshooting

**Error: "hash mismatch"**
- Migration files were modified after applying
- Solution: Don't edit applied migrations

**Error: "cannot connect to database"**
- Check `ATLAS_DEV_DB_URL` in `.env`
- Ensure database server is running

**Error: "models not found"**
- Add model to `GetModelsForMigration()` in `internal/config/database.go`

## Documentation

- **Migration Guide**: [docs/MIGRATION_GUIDE.md](../docs/MIGRATION_GUIDE.md)
- **Database Guide**: [docs/DATABASE.md](../docs/DATABASE.md)
- **Makefile Commands**: [docs/MAKEFILE_COMMANDS.md](../docs/MAKEFILE_COMMANDS.md)
- **Atlas Official**: https://atlasgo.io/

---

**Single Source of Truth**: All models are defined once in `internal/config/database.go::GetModelsForMigration()`
